PROFILE_PROMPT_MSG = "Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù†Ú©ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."
PROFILE_WARNING_MSG = "âš ï¸ Ø¯Ù‚Øª Ú©Ù†ÛŒØ¯: Ù‡Ø±Ú¯ÙˆÙ†Ù‡ Ø§Ø´ØªØ¨Ø§Ù‡ Ø¯Ø± Ù…Ø´Ø®ØµØ§Øª Ø¨Ø§Ù†Ú©ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…Ù†Ø¬Ø± Ø¨Ù‡ ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø§Ø´ØªØ¨Ø§Ù‡ Ø´ÙˆØ¯ Ùˆ Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ø¨Ø± Ø¹Ù‡Ø¯Ù‡ Ø´Ù…Ø§Ø³Øª."
PROFILE_CONFIRM_MSG = "Ø¢ÛŒØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ± Ø±Ø§ ØªØ£ÛŒÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ"
PROFILE_SUCCESS_MSG = "âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ùˆ ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯."
BUY_DISABLED_MSG = "â›”ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø³ÛŒØ³ØªÙ… Ø®Ø±ÛŒØ¯ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª."
BUY_CHOOSE_METHOD_MSG = "Ù„Ø·ÙØ§Ù‹ Ø±ÙˆØ´ Ø§Ù†ØªÙ‚Ø§Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:"
BUY_METHODS_INFO_MSG = "âš ï¸â“ Ú©Ø¯Ø§Ù… Ø±ÙˆØ´ Ø§Ù†ØªÙ‚Ø§Ù„ Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ØŸ\n\n Ù…ØªØ¯Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ´Ø®ÛŒØµ Ø§Ù…Ù†ÛŒØªÛŒ ğŸ¤–Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ +ğŸ‘¤Ø§Ø¯Ù…ÛŒÙ† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯. âš ï¸ "
BUY_METHODS_ERROR_MSG = "â›”ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ØªØ¯Ù‡Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯."
BUY_METHOD_DISABLED_MSG = "â›”ï¸ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø§ÛŒÙ† Ø±ÙˆØ´ Ø±Ø§ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø§Ù…Ù†ÛŒØªÛŒ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù‡ ØŒÙ…ØªØ¯ Ù‡Ø§ÛŒÛŒ Ú©Ù‡ ÙØ¹Ø§Ù„ Ùˆ Ú©Ù… Ø±ÛŒØ³Ú© ØªØ± Ù‡Ø³ØªÙ†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯  ... â›”ï¸"

from telegram import InlineKeyboardButton, InlineKeyboardMarkup
from typing import Tuple

def out_of_range_text(admin_username: str) -> Tuple[str, InlineKeyboardMarkup]:
    text = ("âš ï¸ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ ØªØ´Ø®ÛŒØµ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ùˆ Ø¨Ø±Ø§ÛŒ Ø­ÙØ¸ Ø§Ù…Ù†ÛŒØª Ø§Ú©Ø§Ù†Øª Ø´Ù…Ø§ØŒ "
            "Ø§Ù†ØªÙ‚Ø§Ù„ Ø§ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ø¨Ù‡ØªØ± Ø§Ø³Øª ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ† Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯.âš ï¸")
    kb = InlineKeyboardMarkup([
        [InlineKeyboardButton("ğŸ’¬ Ú†Øª Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ", url=f"https://t.me/{admin_username}")],
        [InlineKeyboardButton("Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ", callback_data="sell:back_to_menu")]
        ])
    return text, kb


def build_card_info_text(selected_range: dict, primary_card: dict, fallback_card: dict, transfer_multiplier: float, amount: float) -> str:
    
    """Ø³Ø§Ø²Ù†Ø¯Ù‡Ù” Ù…ØªÙ† Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Øª Ø¯Ø± ÙÙ„ÙˆÛŒ Ø®Ø±ÛŒØ¯.
    Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§:
      - selected_range: Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ø¨Ø§Ø²Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡
      - primary_card: Ø¯Ø§Ø¯Ù‡Ù” Ø¨Ø§Ø²ÛŒÚ©Ù† Ø§ØµÙ„ÛŒ (Ù…Ø·Ø§Ù„Ø¹Ù‡â€ŒØ´Ø¯Ù‡ Ø§Ø² backend)
      - fallback_card: Ú©Ø§Ø±Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù† (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯)
      - transfer_multiplier: Ø¶Ø±ÛŒØ¨ Ø§Ù†ØªÙ‚Ø§Ù„ (Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø§Ù†ØªÙ‚Ø§Ù„ ØªÙ‚Ø±ÛŒØ¨ÛŒ)
      - amount: Ù…Ù‚Ø¯Ø§Ø± ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±
    ØªØ§Ø¨Ø¹ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø§ÙˆÙ„ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ù‚ÛŒÙ…Øª Ø§Ø² ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…ØªØ¯Ø§ÙˆÙ„ Ø±Ø§ Ø¨Ø®ÙˆØ§Ù†Ø¯:
      estimated_value, futbin_price, buy_now, buyNow, LCPrice
    Ùˆ Ø¯Ø±ØµÙˆØ±Øª Ù†Ø¨ÙˆØ¯Ù† Ù…Ù‚Ø¯Ø§Ø±ØŒ Ù…ØªÙ† Ù…Ù†Ø§Ø³Ø¨ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
    """
    # Helper to normalize price keys
    def _get_price_from_card(card):
        if not card or not isinstance(card, dict):
            return None
        for key in ("estimated_value", "futbin_price", "buy_now", "buyNow", "LCPrice", "price"):
            v = card.get(key)
            if v is None:
                continue
            try:
                return int(v)
            except Exception:
                try:
                    s = str(v).replace(",", "").strip()
                    if s.isdigit():
                        return int(s)
                except Exception:
                    continue
        return None

    player = primary_card.get("player") if isinstance(primary_card, dict) else {}
    name = player.get("name") or primary_card.get("name") or "Ù†Ø§Ù…Ø´Ø®Øµ"
    rating = player.get("rating") or primary_card.get("rating") or "â€”"
    buy_now = _get_price_from_card(primary_card)
    fallback_buy_now = _get_price_from_card(fallback_card)

    lines = []
    lines.append(f"ğŸ”¹ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ø±Ø§ÛŒ: {name} â€” Ø±ØªØ¨Ù‡: {rating}")
    if buy_now is not None:
        approx_transfer = int(buy_now * (transfer_multiplier or 1))
        lines.append(f"ğŸ’° Ù‚ÛŒÙ…Øª ØªÙ‚Ø±ÛŒØ¨ÛŒ (Buy Now): {buy_now:,}")
        lines.append(f"ğŸ“¦ Ù…Ù‚Ø¯Ø§Ø± Ø§Ù†ØªÙ‚Ø§Ù„ ØªÙ‚Ø±ÛŒØ¨ÛŒ (Ø¨Ø§ Ø¶Ø±ÛŒØ¨ {transfer_multiplier}): {approx_transfer:,}")
    elif fallback_buy_now is not None:
        lines.append(f"ğŸ’° Ù‚ÛŒÙ…Øª ØªÙ‚Ø±ÛŒØ¨ÛŒ (Ø§Ø² Ú©Ø§Ø±Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†): {fallback_buy_now:,}")
    else:
        lines.append("âš ï¸ Ù‚ÛŒÙ…Øª ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª â€” Ù…Ù…Ú©Ù† Ø§Ø³Øª Futbin Ù¾Ø§Ø³Ø®Ú¯Ùˆ Ù†Ø¨Ø§Ø´Ø¯.")

    # Add some metadata if present
    if primary_card.get("contract"):
        lines.append(f"ğŸ“„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯: {primary_card.get('contract')}")
    if primary_card.get("owners") is not None:
        lines.append(f"ğŸ‘¥ Ù…Ø§Ù„Ú©ÛŒÙ†: {primary_card.get('owners')}")
    if primary_card.get("games") is not None:
        lines.append(f"ğŸ® Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§: {primary_card.get('games')}")
    if selected_range:
        lines.append(f"ğŸ” Ø¨Ø§Ø²Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡: {selected_range.get('name') or selected_range.get('id', 'Ù†Ø§Ù…Ø´Ø®Øµ')}")

    # elapsed time formatting if provided
    elapsed = primary_card.get("fetched_at_elapsed") or primary_card.get("elapsed") or primary_card.get("age")
    if elapsed:
        lines.append(f"â± Ø²Ù…Ø§Ù† Ø§Ø² Ù„Ø­Ø¸Ù‡ Ø¯Ø±ÛŒØ§ÙØª: {elapsed}")

    # final instruction
    lines.append("\nØ´Ù…Ø§ 60 Ø«Ø§Ù†ÛŒÙ‡ ÙˆÙ‚Øª Ø¯Ø§Ø±ÛŒØ¯ ØªØ§ Ú©Ø§Ø±Øª Ø±Ø§ 'Ù„ÛŒØ³Øª Ú©Ù†' ÛŒØ§ 'Ù†Ù‡ØŒ Ù†Ù…ÛŒâ€ŒØ®ÙˆØ§Ù…'.")
    return "\n".join(lines)
